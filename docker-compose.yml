services:
  db:
    image: mysql:8.0.23
    container_name: rtc_mysql
    restart: always
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-rtc_mysql}
      MYSQL_USER: ${MYSQL_USER:-rtc_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-rtc_password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rtc_password}
      TZ: Asia/Seoul
    ports:
      - "3306:3306"
    volumes:
      - ./db-data:/var/lib/mysql
    networks:
      - rtc-net

  redis:
    image: redis:alpine
    container_name: rtc_redis
    restart: always
    command: redis-server --requirepass ${MYSQL_PASSWORD:-rtc_password} # Using rtc_password as default or logic from env
    ports:
      - "6379:6379"
      - "8001:8001"
    networks:
      - rtc-net

  kms:
    image: kurento/kurento-media-server:6.18.0
    container_name: rtc_kms
    restart: always
    ports:
      - "8888:8888"
      - "50000-50050:50000-50050/udp"
    environment:
      - KMS_MIN_PORT=50000
      - KMS_MAX_PORT=50050
      - KMS_EXTERNAL_ADDRESS=
    networks:
      - rtc-net

  coturn:
    image: coturn/coturn
    container_name: rtc_coturn
    restart: always
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "49152-49200:49152-49200/udp"
    networks:
      - rtc-net
    command:
      - -n
      - --log-file=stdout
      - --min-port=49152
      - --max-port=49200
      - --realm=myrealm
      - --user=myuser:mypassword
      - --lt-cred-mech
      - --fingerprint
      - --external-ip=

networks:
  rtc-net:
    driver: bridge